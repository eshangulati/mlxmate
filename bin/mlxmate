#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
MLXMate - Your MLX-powered coding companion
Global executable for npm package
"""

import os
import sys
import subprocess
from pathlib import Path

def get_conda_python():
    """Get the Python executable from the active conda environment"""
    # Check if we're in a conda environment
    conda_env = os.environ.get('CONDA_DEFAULT_ENV')
    if conda_env:
        # Get the conda prefix
        conda_prefix = os.environ.get('CONDA_PREFIX')
        if conda_prefix:
            # Return the Python executable from the conda environment
            return os.path.join(conda_prefix, 'bin', 'python')
    
    # Fall back to the current Python executable
    return sys.executable
"""
MLXMate - Your MLX-powered coding companion
Global executable for npm package
"""

import os
import sys
import subprocess
from pathlib import Path

def get_package_root():
    """Get the root directory of the installed package"""
    # Get the directory where this script is located
    script_dir = Path(__file__).parent.parent.absolute()
    
    # If this is a global npm installation, the structure is different
    if script_dir.name == 'bin':
        # We're in /usr/local/bin or /opt/homebrew/bin, so go up to lib/node_modules/mlxmate
        return script_dir.parent / 'lib' / 'node_modules' / 'mlxmate'
    elif script_dir.name == 'node_modules':
        # We're in node_modules, so the package is the next directory
        return script_dir / 'mlxmate'
    elif script_dir.name == 'homebrew':
        # We're in /opt/homebrew, so go to lib/node_modules/mlxmate
        return script_dir / 'lib' / 'node_modules' / 'mlxmate'
    
    return script_dir

def main():
    """Main entry point"""
    # Get the package root directory
    package_root = get_package_root()
    
    # Change to the package directory
    os.chdir(package_root)
    
    # Add the package root to Python path
    sys.path.insert(0, str(package_root))
    
    # Check if we have command line arguments
    if len(sys.argv) > 1:
        command = sys.argv[1]
        args = sys.argv[2:]
        
        if command == "interactive":
            # Run interactive mode
            try:
                from interactive_mlx import main as interactive_main
                import asyncio
                asyncio.run(interactive_main())
            except ImportError as e:
                print(f"Error: Could not import interactive_mlx module: {e}")
                print("Make sure you're in the correct directory and all files are present.")
                sys.exit(1)
        elif command == "test":
            # Run test
            try:
                from test_mlx import test_mlx
                import asyncio
                asyncio.run(test_mlx())
            except ImportError as e:
                print(f"Error: Could not import test_mlx module: {e}")
                print("Make sure you're in the correct directory and all files are present.")
                sys.exit(1)
        elif command == "setup":
            # Run setup
            subprocess.run([get_conda_python(), "terminal_claude.py", "setup"])
        elif command == "help":
            # Show help
            print("MLXMate - Your MLX-powered coding companion")
            print("\nUsage:")
            print("  mlxmate                            # Start interactive mode")
            print("  mlxmate interactive                # Start interactive chat")
            print("  mlxmate test                       # Test MLX integration")
            print("  mlxmate setup                      # Run initial setup")
            print("  mlxmate help                       # Show this help")
            print("\nCommands:")
            print("  mlxmate search <query>             # Search codebase")
            print("  mlxmate analyze <file>             # Analyze a file")
            print("  mlxmate generate <prompt>          # Generate code")
            print("  mlxmate review <file>              # Review code")
            print("  mlxmate refactor <file>            # Refactor code")
        else:
            # Pass through to the main terminal_claude.py
            subprocess.run([get_conda_python(), "terminal_claude.py"] + sys.argv[1:])
    else:
        # No arguments, start interactive mode
        try:
            from interactive_mlx import main as interactive_main
            import asyncio
            asyncio.run(interactive_main())
        except ImportError as e:
            print(f"Error: Could not import interactive_mlx module: {e}")
            print("Make sure you're in the correct directory and all files are present.")
            sys.exit(1)

if __name__ == "__main__":
    main()
